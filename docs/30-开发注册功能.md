# ğŸ›’ å¼€å‘æ³¨å†ŒåŠŸèƒ½

---

## 1. å¼€å‘æ­¥éª¤

è®¿é—®æ³¨å†Œé¡µé¢

æäº¤æ³¨å†Œæ•°æ®ï¼š

- é€šè¿‡è¡¨å•æäº¤æ•°æ®
- æœåŠ¡ç«¯éªŒè¯è´¦å·æ˜¯å¦å·²å­˜åœ¨ã€é‚®ç®±æ˜¯å¦å·²æ³¨å†Œ
- æœåŠ¡ç«¯å‘é€æ¿€æ´»é‚®ä»¶

æ¿€æ´»æ³¨å†Œè´¦å·ï¼š

- ç‚¹å‡»é‚®ä»¶ä¸­çš„é“¾æ¥ï¼Œè®¿é—®æœåŠ¡ç«¯çš„æ¿€æ´»æœåŠ¡

## 2. ä»£ç ç¼–å†™

### â‘  æäº¤æ³¨å†Œæ•°æ®

#### UserService

```java
package com.greate.community.service;

import com.greate.community.dao.UserMapper;
import com.greate.community.entity.User;
import com.greate.community.util.CommunityUtil;
import com.greate.community.util.MailClient;
import org.apache.commons.lang3.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;
import org.thymeleaf.TemplateEngine;
import org.thymeleaf.context.Context;

import java.util.Date;
import java.util.HashMap;
import java.util.Map;
import java.util.Random;

@Service
public class UserService {

    @Autowired
    private UserMapper userMapper;

    @Autowired
    private MailClient mailClient;

    @Autowired
    private TemplateEngine templateEngine;

    // ç½‘ç«™åŸŸå
    @Value("${community.path.domain}")
    private String domain;

    // é¡¹ç›®å http://localhost:8080/greatecommunity/......
    @Value("${server.servlet.context-path}")
    private String contextPath;

    /**
     * æ ¹æ® Id æŸ¥è¯¢ç”¨æˆ·
     * @param id
     * @return
     */
    public User findUserById (int id) {
        return userMapper.selectById(id);
    }

    /**
     * ç”¨æˆ·æ³¨å†Œ
     * @param user
     * @return Map<String, Object> è¿”å›é”™è¯¯æç¤ºæ¶ˆæ¯ï¼Œå¦‚æœè¿”å›çš„ map ä¸ºç©ºï¼Œåˆ™è¯´æ˜æ³¨å†ŒæˆåŠŸ
     */
    public Map<String, Object> register(User user) {
        Map<String, Object> map = new HashMap<>();

        if (user == null) {
            throw new IllegalArgumentException("å‚æ•°ä¸èƒ½ä¸ºç©º");
        }
        if (StringUtils.isBlank(user.getUsername())) {
            map.put("usernameMsg", "è´¦å·ä¸èƒ½ä¸ºç©º");
            return map;
        }

        if (StringUtils.isBlank(user.getPassword())) {
            map.put("passwordMsg", "å¯†ç ä¸èƒ½ä¸ºç©º");
            return map;
        }

        if (StringUtils.isBlank(user.getEmail())) {
            map.put("emailMsg", "é‚®ç®±ä¸èƒ½ä¸ºç©º");
            return map;
        }

        // éªŒè¯è´¦å·æ˜¯å¦å·²å­˜åœ¨
        User u = userMapper.selectByName(user.getUsername());
        if (u != null) {
            map.put("usernameMsg", "è¯¥è´¦å·å·²å­˜åœ¨");
            return map;
        }

        // éªŒè¯é‚®ç®±æ˜¯å¦å·²å­˜åœ¨
        u = userMapper.selectByEmail(user.getEmail());
        if (u != null) {
            map.put("emailMsg", "è¯¥é‚®ç®±å·²è¢«æ³¨å†Œ");
            return map;
        }

        // æ³¨å†Œç”¨æˆ·
        user.setSalt(CommunityUtil.generateUUID().substring(0, 5)); // salt
        user.setPassword(CommunityUtil.md5(user.getPassword() + user.getSalt())); // åŠ ç›åŠ å¯†
        user.setType(0); // é»˜è®¤æ™®é€šç”¨æˆ·
        user.setStatus(0); // é»˜è®¤æœªæ¿€æ´»
        user.setActivationCode(CommunityUtil.generateUUID()); // æ¿€æ´»ç 
        // éšæœºå¤´åƒï¼ˆç”¨æˆ·ç™»å½•åå¯ä»¥è‡ªè¡Œä¿®æ”¹ï¼‰
        user.setHeaderUrl(String.format("http://images/nowcoder.com/head/%dt.png", new Random().nextInt(1000)));
        user.setCreateTime(new Date()); // æ³¨å†Œæ—¶é—´
        userMapper.insertUser(user);

        // ç»™æ³¨å†Œç”¨æˆ·å‘é€æ¿€æ´»é‚®ä»¶
        Context context = new Context();
        context.setVariable("email", user.getEmail());
        // http://localhost:8080/greatecommunity/activation/ç”¨æˆ·id/æ¿€æ´»ç 
        String url = domain + contextPath + "/activation" + user.getId() + "/" + user.getActivationCode();
        context.setVariable("url", url);
        String content = templateEngine.process("/mail/activation", context);
        mailClient.sendMail(user.getEmail(),"æ¿€æ´» Greate Community è´¦å·", content);

        return map;
    }

}
```

#### LoginController

```java
/**
 * ç™»å½•æ³¨å†Œ
 */
@Controller
public class LoginController {

    @Autowired
    UserService userService;

    /**
     * è¿›å…¥æ³¨å†Œç•Œé¢
     * @return
     */
    @GetMapping("/register")
    public String getRegisterPage() {
        return "site/register";
    }

    /**
     * æ³¨å†Œç”¨æˆ·
     * @param model
     * @param user
     * @return
     */
    @PostMapping("/register")
    public String register(Model model, User user) {
        Map<String, Object> map = userService.register(user);
        if (map == null || map.isEmpty()) {
            model.addAttribute("msg", "æ³¨å†ŒæˆåŠŸ, æˆ‘ä»¬å·²ç»å‘æ‚¨çš„é‚®ç®±å‘é€äº†ä¸€å°æ¿€æ´»é‚®ä»¶ï¼Œè¯·å°½å¿«æ¿€æ´»!");
            model.addAttribute("target", "/index");
            return "/site/operate-result";
        } else {
            model.addAttribute("usernameMsg", map.get("usernameMsg"));
            model.addAttribute("passwordMsg", map.get("passwordMsg"));
            model.addAttribute("emailMsg", map.get("emailMsg"));
            return "/site/register";
        }
    }

}
```

æ³¨å†ŒæˆåŠŸä¼šè·³è½¬åˆ°ä¸€ä¸ªä¸­é—´ç•Œé¢ï¼š`operate-result`ï¼Œæç¤ºç”¨æˆ·æ³¨å†ŒæˆåŠŸï¼Œå¹¶å‰å¾€é‚®ç®±è¿›è¡Œæ¿€æ´»

```html
<p>
    ç³»ç»Ÿä¼šåœ¨ <span id="seconds" class="text-danger">8</span> ç§’åè‡ªåŠ¨è·³è½¬,
    æ‚¨ä¹Ÿå¯ä»¥ç‚¹å‡» <a id="target" th:href="@{${target}}" class="text-primary">æ­¤é“¾æ¥</a>, æ‰‹åŠ¨è·³è½¬!
</p>
```

#### å‰ç«¯é€šè¿‡è¡¨å•æäº¤æ•°æ®

```html
<form class="mt-5" method="post" th:action="@{/register}">
	<input name = "username" />
```

SpringMVC åŸºäºåŒååŸåˆ™ï¼ŒæŠŠå‰ç«¯çš„ username ä¼ ç»™ user.username

```java
@PostMapping("/register")
public String register(Model model, User user)
```

### â‘¡ æ¿€æ´»æ³¨å†Œè´¦å·

#### UserService

```java
/**
 * æ¿€æ´»ç”¨æˆ·
 * @param userId ç”¨æˆ· id
 * @param code æ¿€æ´»ç 
 * @return
 */
public int activation(int userId, String code) {
    User user = userMapper.selectById(userId);
    if (user.getStatus() == 1) {
        // ç”¨æˆ·å·²æ¿€æ´»
        return ACTIVATION_REPEAT;
    }
    else if (user.getActivationCode().equals(code)) {
        // ä¿®æ”¹ç”¨æˆ·çŠ¶æ€ä¸ºå·²æ¿€æ´»
        userMapper.updateStatus(userId, 1);
        return ACTIVATION_SUCCESS;
    }
    else {
        return ACTIVATION_FAILURE;
    }
}
```

#### LoginController

ç”¨æˆ·æ”¶åˆ°æ¿€æ´»é‚®ä»¶åï¼Œç‚¹å‡»é‚®ä»¶ä¸­çš„é“¾æ¥ï¼Œåˆ™æ¿€æ´»è¯¥ç”¨æˆ·

```java
	// ç”¨æˆ·æ¿€æ´»
    // http://localhost:8080/greatecommunity/activation/ç”¨æˆ·id/æ¿€æ´»ç 
    @GetMapping("/activation/{userId}/{code}")
    public String activation(Model model, @PathVariable("userId") int userId, @PathVariable("code") String code) {
        int result = userService.activation(userId, code);
        if (result == ACTIVATION_SUCCESS) {
            model.addAttribute("msg", "æ¿€æ´»æˆåŠŸ, æ‚¨çš„è´¦å·å·²ç»å¯ä»¥æ­£å¸¸ä½¿ç”¨!");
            model.addAttribute("target", "/login");
        }
        else if (result == ACTIVATION_REPEAT) {
            model.addAttribute("msg", "æ— æ•ˆçš„æ“ä½œ, æ‚¨çš„è´¦å·å·²è¢«æ¿€æ´»è¿‡!");
            model.addAttribute("target", "/index");
        }
        else {
            model.addAttribute("msg", "æ¿€æ´»å¤±è´¥, æ‚¨æä¾›çš„æ¿€æ´»ç ä¸æ­£ç¡®!");
            model.addAttribute("target", "/index");
        }
        return "/site/operate-result";
    }
```


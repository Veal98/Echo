# å¼€å‘ç¤¾åŒºé¦–é¡µ

---

![](https://gitee.com/veal98/images/raw/master/img/20210116110550.png)

## DiscussPost è®¨è®ºå¸–

### Entity

### DAO

- Mapper æ¥å£ `DiscussPostMapper`
- å¯¹åº”çš„ xml é…ç½®æ–‡ä»¶ `discusspost-mapper.xml`

`@Param` æ³¨è§£ç”¨äºç»™å‚æ•°èµ·åˆ«åï¼Œ**å¦‚æœåªæœ‰ä¸€ä¸ªå‚æ•°**ï¼Œå¹¶ä¸”éœ€è¦åœ¨ `<if>` é‡Œä½¿ç”¨ï¼Œåˆ™å¿…é¡»åŠ åˆ«å

```java
@Mapper
public interface DiscussPostMapper {

    /**
     * åˆ†é¡µæŸ¥è¯¢è®¨è®ºè´´ä¿¡æ¯
     *
     * @param userId å½“ä¼ å…¥çš„ userId = 0 æ—¶æŸ¥æ‰¾æ‰€æœ‰ç”¨æˆ·çš„å¸–å­
     *               å½“ä¼ å…¥çš„ userId != 0 æ—¶ï¼ŒæŸ¥æ‰¾è¯¥æŒ‡å®šç”¨æˆ·çš„å¸–å­
     * @param offset æ¯é¡µçš„èµ·å§‹ç´¢å¼•
     * @param limit  æ¯é¡µæ˜¾ç¤ºå¤šå°‘æ¡æ•°æ®
     * @return
     */
    List<DiscussPost> selectDiscussPosts(int userId, int offset, int limit);

    /**
     * æŸ¥è¯¢è®¨è®ºè´´çš„ä¸ªæ•°
     * @param userId å½“ä¼ å…¥çš„ userId = 0 æ—¶è®¡ç®—æ‰€æœ‰ç”¨æˆ·çš„å¸–å­æ€»æ•°
     *               å½“ä¼ å…¥çš„ userId ï¼= 0 æ—¶è®¡ç®—è¯¥æŒ‡å®šç”¨æˆ·çš„å¸–å­æ€»æ•°
     * @return
     */
    int selectDiscussPostRows(@Param("userId") int userId);
}
```

å¯¹åº”çš„ Mapperï¼š

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.greate.community.dao.DiscussPostMapper">

    <sql id = "selectFields">
        id, user_id, title, content, type, status, create_time, comment_count, score
    </sql>

    <!--åˆ†é¡µæŸ¥è¯¢è®¨è®ºè´´ä¿¡æ¯-->
    <!--ä¸æ˜¾ç¤ºæ‹‰é»‘çš„å¸–å­, æŒ‰ç…§æ˜¯å¦ç½®é¡¶å’Œåˆ›å»ºæ—¶é—´æ’åº-->
    <select id = "selectDiscussPosts" resultType="DiscussPost">
        select <include refid="selectFields"></include>
        from discuss_post
        where status != 2
        <if test = "userId!=0">
            and user_id = #{userId}
        </if>
        order by type desc, create_time desc
        limit #{offset}, #{limit}
    </select>

    <!--æŸ¥è¯¢è®¨è®ºè´´çš„ä¸ªæ•°-->
    <select id = "selectDiscussPostRows" resultType="int">
        select count(id)
        from discuss_post
        where status != 2
        <if test = "userId != 0">
            and user_id = #{userId}
        </if>
    </select>

</mapper>
```

### Service

å…³äºè‡ªåŠ¨æ³¨å…¥ Mapper æŠ¥é”™é—®é¢˜ï¼šå¯å‚è€ƒ [å…³äºIDEAä¸­@Autowired æ³¨è§£æŠ¥é”™~å›¾æ–‡](https://www.cnblogs.com/taopanfeng/p/10994075.html)

```java
@Service
public class DiscussPostSerivce {

    @Autowired
    private DiscussPostMapper discussPostMapper;


    /**
     * åˆ†é¡µæŸ¥è¯¢è®¨è®ºå¸–ä¿¡æ¯
     *
     * @param userId å½“ä¼ å…¥çš„ userId = 0 æ—¶æŸ¥æ‰¾æ‰€æœ‰ç”¨æˆ·çš„å¸–å­
     *               å½“ä¼ å…¥çš„ userId != 0 æ—¶ï¼ŒæŸ¥æ‰¾è¯¥æŒ‡å®šç”¨æˆ·çš„å¸–å­
     * @param offset æ¯é¡µçš„èµ·å§‹ç´¢å¼•
     * @param limit  æ¯é¡µæ˜¾ç¤ºå¤šå°‘æ¡æ•°æ®
     * @return
     */
    public List<DiscussPost> findDiscussPosts (int userId, int offset, int limit) {
        return discussPostMapper.selectDiscussPosts(userId, offset, limit);
    }

    /**
     * æŸ¥è¯¢è®¨è®ºè´´çš„ä¸ªæ•°
     * @param userId å½“ä¼ å…¥çš„ userId = 0 æ—¶è®¡ç®—æ‰€æœ‰ç”¨æˆ·çš„å¸–å­æ€»æ•°
     *               å½“ä¼ å…¥çš„ userId ï¼= 0 æ—¶è®¡ç®—è¯¥æŒ‡å®šç”¨æˆ·çš„å¸–å­æ€»æ•°
     * @return
     */
    public int findDiscussPostRows (int userId) {
        return discussPostMapper.selectDiscussPostRows(userId);
    }

}
```

## User

### Entity

### DAO

```java
@Mapper
public interface UserMapper {

    /**
     * æ ¹æ® id æŸ¥è¯¢ç”¨æˆ·
     * @param id
     * @return
     */
    User selectById (int id);

    /**
     * æ ¹æ® username æŸ¥è¯¢ç”¨æˆ·
     * @param username
     * @return
     */
    User selectByName(String username);

    /**
     * æ ¹æ® email æŸ¥è¯¢ç”¨æˆ·
     * @param email
     * @return
     */
    User selectByEmail(String email);

    /**
     * æ’å…¥ç”¨æˆ·ï¼ˆæ³¨å†Œï¼‰
     * @param user
     * @return
     */
    int insertUser(User user);

    /**
     * ä¿®æ”¹ç”¨æˆ·çŠ¶æ€
     * @param id
     * @param status 0ï¼šæœªæ¿€æ´»ï¼Œ1ï¼šå·²æ¿€æ´»
     * @return
     */
    int updateStatus(int id, int status);

    /**
     * ä¿®æ”¹å¤´åƒ
     * @param id
     * @param headerUrl
     * @return
     */
    int updateHeader(int id, String headerUrl);

    /**
     * ä¿®æ”¹å¯†ç 
     * @param id
     * @param password
     * @return
     */
    int updatePassword(int id, String password);

}
```

å¯¹åº”çš„ mapper.xmlï¼š

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.greate.community.dao.UserMapper">

    <sql id = "insertFields">
        username, password, salt, email, type, status, activation_code, header_url, create_time
    </sql>

    <sql id = "selectFields">
        id, username, password, salt, email, type, status, activation_code, header_url, create_time
    </sql>

    <!--æ ¹æ® Id æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯-->
    <select id = "selectById" resultType = "User">
        select <include refid="selectFields"></include>
        from user
        where id = #{id}
    </select>

    <!--æ ¹æ® Username æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯-->
    <select id="selectByName" resultType="User">
        select <include refid="selectFields"></include>
        from user
        where username = #{username}
    </select>

    <!--æ ¹æ® email æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯-->
    <select id="selectByEmail" resultType="User">
        select <include refid="selectFields"></include>
        from user
        where email = #{email}
    </select>

    <!--æ’å…¥ç”¨æˆ·ä¿¡æ¯ï¼ˆæ³¨å†Œï¼‰-->
    <insert id="insertUser" parameterType="User" keyProperty="id">
        insert into user (<include refid="insertFields"></include>)
        values(#{username}, #{password}, #{salt}, #{email}, #{type}, #{status}, #{activationCode}, #{headerUrl}, #{createTime})
    </insert>

    <!--ä¿®æ”¹ç”¨æˆ·çŠ¶æ€-->
    <update id="updateStatus">
        update user set status = #{status} where id = #{id}
    </update>

    <!--ä¿®æ”¹ç”¨æˆ·å¤´åƒ-->
    <update id="updateHeader">
        update user set header_url = #{headerUrl} where id = #{id}
    </update>

    <!--ä¿®æ”¹å¯†ç -->
    <update id="updatePassword">
        update user set password = #{password} where id = #{id}
    </update>

</mapper>
```

### Service

```java
@Service
public class UserService {

    @Autowired
    private UserMapper userMapper;

    public User findUserById (int id) {
        return userMapper.selectById(id);
    }

}
```

## Page åˆ†é¡µ

```java
/**
 * å°è£…åˆ†é¡µç›¸å…³çš„ä¿¡æ¯
 */
public class Page {

    // å½“å‰çš„é¡µç 
    private int current = 1;
    // å•é¡µæ˜¾ç¤ºçš„å¸–å­æ•°é‡ä¸Šé™
    private int limit = 10;
    // å¸–å­æ€»æ•°ï¼ˆç”¨äºè®¡ç®—æ€»é¡µæ•°ï¼‰
    private int rows;
    // æŸ¥è¯¢è·¯å¾„ï¼ˆç”¨äºå¤ç”¨åˆ†é¡µé“¾æ¥, å› ä¸ºæˆ‘ä»¬ä¸åªåœ¨é¦–é¡µä¸­æœ‰åˆ†é¡µï¼Œå…¶ä»–ç•Œé¢ä¹Ÿä¼šæœ‰åˆ†é¡µï¼‰
    private String path;

    public int getCurrent() {
        return current;
    }

    public void setCurrent(int current) {
        if (current >= 1) {
            this.current = current;
        }
    }

    public int getLimit() {
        return limit;
    }

    public void setLimit(int limit) {
        if (current >= 1 && limit <= 100) {
            this.limit = limit;
        }
    }

    public int getRows() {
        return rows;
    }

    public void setRows(int rows) {
        if (rows >= 0) {
            this.rows = rows;
        }
    }

    public String getPath() {
        return path;
    }

    public void setPath(String path) {
        this.path = path;
    }

    /**
     * è·å–å½“å‰é¡µçš„èµ·å§‹ç´¢å¼• offset
     * @return
     */
    public int getOffset() {
        return current * limit - limit;
    }

    /**
     * è·å–æ€»é¡µæ•°
     * @return
     */
    public int getTotal() {
        if (rows % limit == 0) {
            return rows / limit;
        }
        else {
            return rows / limit + 1;
        }
    }

    /**
     * è·å–åˆ†é¡µæ èµ·å§‹é¡µç 
     * åˆ†é¡µæ æ˜¾ç¤ºå½“å‰é¡µç åŠå…¶å‰åä¸¤é¡µ
     * @return
     */
    public int getFrom() {
        int from = current - 2;
        return from < 1 ? 1 : from;
    }

    /**
     * è·å–åˆ†é¡µæ ç»“æŸé¡µç 
     * @return
     */
    public int getTo() {
        int to = current + 2;
        int total = getTotal();
        return to > total ? total : to;
    }
}

```

## Controller

```java
@Controller
public class HomeController {

    @Autowired
    private DiscussPostSerivce discussPostSerivce;

    @Autowired
    private UserService userService;

    @GetMapping("/index")
    public String getIndexPage(Model model, Page page) {
        // è·å–æ€»é¡µæ•°
        page.setRows(discussPostSerivce.findDiscussPostRows(0));
        page.setPath("/index");

        // åˆ†é¡µæŸ¥è¯¢
        List<DiscussPost> list = discussPostSerivce.findDiscussPosts(0, page.getOffset(), page.getLimit());
        // å°è£…å¸–å­å’Œè¯¥å¸–å­å¯¹åº”çš„ç”¨æˆ·ä¿¡æ¯
        List<Map<String, Object>> discussPosts = new ArrayList<>();
        if (list != null) {
            for (DiscussPost post : list) {
                Map<String, Object> map = new HashMap<>();
                map.put("post", post);
                User user = userService.findUserById(post.getUserId());
                map.put("user", user);
                discussPosts.add(map);
            }
        }
        model.addAttribute("discussPosts", discussPosts);
        return "index";
    }

}
```

ğŸš© å° Tipï¼šè¿™é‡Œä¸ç”¨æŠŠ Page æ”¾å…¥ modelï¼ˆ`model.addAttribute("page", page);`

å› ä¸ºåœ¨æ–¹æ³•è°ƒç”¨ä¹‹å‰ï¼ŒSpring MVC ä¼šè‡ªåŠ¨å®ä¾‹åŒ– Model å’Œ Pageï¼Œå¹¶å°† Page æ³¨å…¥ Modelï¼Œæ‰€ä»¥ï¼Œåœ¨ Thymeleaf ä¸­å¯ä»¥ç›´æ¥è®¿é—® Page å¯¹è±¡ä¸­çš„æ•°æ®

## å‰ç«¯ç•Œé¢ index.html

```html
th:each="map:${discussPosts}"
```

è¡¨ç¤ºå°†æ¯æ¬¡éå† `discussPosts` å–å‡ºçš„å˜é‡ç§°ä¸º `map`

